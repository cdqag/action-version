name: Version
description: Get the next version based on the latest tag

author: "CDQ AG"
branding:
  icon: 'arrow-up-circle'
  color: 'red'

outputs:
  current:
    description: The current version
    value: ${{ steps.set.outputs.current }}

  next:
    description: Next (new) version
    value: ${{ steps.set.outputs.next }}

  nextMajor:
    description: Next (new) major version
    value: ${{ steps.set.outputs.nextMajor }}

runs:
  using: 'composite'
  steps:
    - name: Set variables
      shell: bash
      env:
        BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      run: |
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

    - name: Get Next Version
      id: semver
      uses: ietf-tools/semver-action@v1
      with:
        token: ${{ github.token }}
        branch: ${{ env.BRANCH_NAME }}
        noVersionBumpBehavior: patch

    - name: Set Outputs
      id: set
      shell: bash
      env:
        NEXT: ${{ steps.semver.outputs.nextStrict }}
        GITHUB_SHA_SHORT: ${{ substr(github.sha, 0, 8) }}
      run: |
       echo "current=${{ steps.semver.outputs.current }}" >> "$GITHUB_OUTPUT"
       echo "nextMajor=${{ steps.semver.outputs.nextMajorStrict }}" >> "$GITHUB_OUTPUT"

       if [[ "$BRANCH_NAME" != "master" ]]; then
         NEXT="$NEXT-$GITHUB_SHA_SHORT"
       fi
       echo "next=$NEXT" >> "$GITHUB_OUTPUT"
