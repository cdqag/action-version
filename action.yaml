name: Version
description: Get the next version based on the latest tag

author: "CDQ AG"
branding:
  icon: 'arrow-up-circle'
  color: 'red'

outputs:
  current:
    description: The current version
    value: ${{ steps.set.outputs.current }}

  next:
    description: Next (new) version
    value: ${{ steps.set.outputs.next }}

  nextPep440:
    description: Next (new) version (PEP440 compliant)
    value: ${{ steps.set.outputs.nextPep440 }}

  nextMajor:
    description: Next (new) major version
    value: ${{ steps.set.outputs.nextMajor }}

runs:
  using: 'composite'
  steps:
    - name: Check Prerequisites
      shell: bash
      run: |
        if [[ -z "$BRANCH_NAME" ]]; then
          echo "This action requires env.BRANCH_NAME to be set. Please either use cdqag/action-init, or manualy set env.BRANCH_NAME."
          exit 1
        fi

    - name: Get Next Version
      id: semver
      uses: ietf-tools/semver-action@v1
      with:
        token: ${{ github.token }}
        branch: ${{ env.BRANCH_NAME }}
        noVersionBumpBehavior: patch

    - name: Set Outputs
      id: set
      shell: bash
      env:
        NEXT: ${{ steps.semver.outputs.nextStrict }}
      run: |
        echo "current=${{ steps.semver.outputs.current }}" >> "$GITHUB_OUTPUT"
        echo "nextMajor=${{ steps.semver.outputs.nextMajorStrict }}" >> "$GITHUB_OUTPUT"

        if [[ "$BRANCH_NAME" != "master" ]]; then
          NEXT="$NEXT-${GITHUB_SHA:0:8}"
        fi
        echo "next=$NEXT" >> "$GITHUB_OUTPUT"

        NEXT_PEP440=$(echo "$NEXT" | sed 's/-/+/g')
        echo "nextPep440=$NEXT_PEP440" >> "$GITHUB_OUTPUT"
